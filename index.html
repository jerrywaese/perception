<!DOCTYPE html>
<html lang="en">
  <head>

    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="Description" content="Consciousness and associative memory modelling." />
    <meta name="Keywords" content="associative brain wiring, memory, engrams, perception, association" />

    <title>Associative Engram Demo </title>
    <style type="text/css">   
          body { width: 100%;height: 100%;}
          .page {  width: 95%;  height: 95%;  
            font-family: Arial,Helvetica,sans-serif;  background-color: #ffffff;  top: 0px;  left: 0px;  position: absolute;}
          #leftside{position: absolute;left: 25px; top: 25px;}
          #rightside{position: absolute;left: 650px;top: 25px; margin-left: 10px; width: 600px; }
          #info{position: absolute;left: 25px; top: 380px; width:95%;margin:10px;}
          .enhance{background: yellow;}
          #key1{background: yellow; width:27%; height:48px;padding: 10px; margin-left:10px; float:left; font-weight: bold;}
          #key2{background: yellow; width:27%; height:48px;padding: 10px;margin-left:10px;float:left;font-weight: bold;}
          #key3{background: yellow; width:25%; height:48px;padding: 10px;margin-left:10px;float:left;font-weight: bold;}
          #messageArea{position: absolute;left: 10px; top: 220px; width:95%;margin:10px;}
          #imageToSense{ width:300px; position:absolute; left:25px;top:25px;}
          #corticalCanvas{ width:300px; position:absolute; left:325px;top:25px;z-index: 1;}}
          #process{width:300px; position:absolute; left:325px;top:25px;z-index: 5;}
          #description{float:left;width:80%;margin:14px;height:100px;}
          #dash{left: 10px; top:340px; position: absolute;  height:40px;} 
          #imgSelector{position: absolute;left: 600px; top: 80px; width:521px;height:66px;z-index: 20;display:none;}

      </style>
  </head>

  <body onload="doBodyLoad();">
    <div class="page">
      version 1.039 - Apr. 27 2022 
      <main>
        <div id="leftside" >            
          <canvas id="imageToSense" width="300" height="300"></canvas>  
          <canvas id="corticalCanvas" width="300" height="300"></canvas> 
          <canvas id="process" width="300" height="300"></canvas>
        </div>
        <div id="rightside">
          <div id="key1" onclick='button1();'>1</div>       
          <div id="key2" onclick='button2();'>2</div>        
          <div id="key3" onclick='button3();'>3</div>
          <br/>
          <div id="description">
            A simulation of a B + W image being sensed 
            in a synchronous neural association network. <br/>
            When the system is ready you can initiate perception with the middle button above, or you can change the  sensory input image with right button above. - Play with several random perceptions before switching to another image. - 
            Use right mouse button to see active branches coming to a (yellow) active neuron or left mouse button to see  branches emerging from an activated pyramidal neuron marked in light magenta. 
          </div>
          <div id="messageArea">
            <h2 id="mess" >hi</h1>
          </div>
        </div>
        <div id="dash">
        </div>
        <div id="imgSelector" >
          <img src="images.png"/>
        </div>
        <div id="info">
          

          When the system begins a black and white image is rendered in yellow on black simulating a pattern of activated cortical neurons (<i>this is a generalized illustration of cortical activation, not a specific visual cortex pattern (which could have color info etc.)</i>).<br/><br/>

          The activation of these cortical neurons comes as a series of (feedback) pulses through the thalamus (which is not obvious here until you use the <span class="enhance">[Begin Random Partial Perception]</span> button). Activation is characterized by electrical field events which can be picked up by EEG, centered on the activated cortical neurons. <br/><br/>

          Where that kind of event is strongest (shown as red field energy i.e. close to the excited neuron), it excites the nearby branching pyramidal neuron(s), each of which, in this demo, connects up to <span id="nPyramidalBranches">999</span> other cortical neurons, and making minisynapses (from new (ARC) protein spines) with any activated cortical neurons they contact (thus forming synchronous linkage - "Neurons that fire together wire together"). <br/><br/> <b>If you click on an active pyramidal location (magenta) </b> you may see the blue pyramidal neuron branches that have been involved in the current image memory engram.  Often these activated pyramidal neurons send branched mini-signals far from the location where they were triggered, enhancing the ability to associate neurons that fire at the same time which could be in a different place including neurons representing activity of other senses or mental events.  
          <br/><br/> <b>If you right click on an active point (yellow) </b> the collaborating pyramidals which activated this cortical neuron will be shown with all their active branches. Usually it will be more than <span id="branchesReq4Perception2">2</span> Pyramidals that have activated the neuron.<br/><br/>
<center>
            <img src="branches.png" /><br/>
            Branches from an activated Pyramidal Neuron are shown that are involved in this perception using blue lines (from left clicking), and using aqua color when invoked (by right clicking) over a new perception activation shown as a yellow bit.

</center>          <br/><br/>
          After the simulated memory formation is done, you can click on the second button <span class="enhance">[Begin Random Partial Perception]</span>  to observe <b>progressive perception</b> from  a small randomly generated piece of the original image activating the simulated cortex. <b>Each time you press  [Begin Random Partial Perception], a different random piece of the image will be used</b>, and you can get a good idea of how progressive perception is supported by a short series of top down thalamic feedback activations.    <br/><br/>

          When <span id="branchesReq4Perception">3</span> or more minisynapses (<u>on resting cortical neurons</u>) are triggered by branches of activated pyramidal neurons, a pattern begins to emerge progressively, and it expands with each feedback pulse from the thalamus. This (<i>six pulses</i>) is what goes on each time you click the middle button above  <span class="enhance">[Begin Random Partial Perception]</span>; so I suggest doing it a few times to see how different fragments awaken parts of the whole original image.
              <br/><br/>
          You can click on the third button <span class="enhance">[Load Other Image]</span> to get a different image activation and observe the effects.  As you go through the images, you may notice some memory crosstalk between the images that are recalled by the partial input. Sometimes it takes a while to see what is similar between the image parts that come through from another memory; usually it is a large undifferentiated area which causes cross-talk and some effort is made here to mimic how the retina deals with non-contrasting blocks of light or dark.<br/><br/>
          <center>
            <img src="images.png" /><br/>
            The image selector appears when you press <span class="enhance">[Load Other Image]</span><br/>
            This simple demo only has a few images on the server as there are some cross domain issues <br/>with the JavaScript Canvas that make it easier for me to use images located where the web page is hosted.

</center>          <br/><br/>
          This demo does not implement hypothalamic suppression modelling which can be used to suppress current actives and enable more refined/restricted recognition. It also does not model short term memory, which would involve distinguising between recent activations and resting neurons that were not recently activated.
          <br/><br/>
          This demo is a simulation for some of the ideas promoted in my earlier paper 
          <a href="https://www.researchgate.net/publication/359636101_Associative_Memory_Formation_and_Perception_A_Consideration_of_How_Ephaptic_Cortical_Field_Interference_Excites_Branched_Pyramidal_Neuron_Axons_to_Link_with_Synchronously_Activated_Primary_Cortical_Se" target="_blank">
            Associative Memory Formation and Perception</a> 
           posted in  March 2022; although references to ephaptic field interference are superceded with a simpler approach.  <br/><br/><br/><br/><br/><br/><br/><br/><br/>
          © Jerry Waese 2022<br/>
          
        </div>
      </main>
    </div>
    <script type="text/javascript">
      //© Jerry Waese 2022 all rights reserved
    
      var corticalCanvas;
      var corticalCtx;
      var sensoryCanvas;
      var sensoryCtx;
      var imgData;
      var pixelData;//used with activate PyramidalsToMakeSpines 
            
      var gridWidth;
      var gridHeight;
      var theDataLength;
      var corticalNeurons=[];//modelling cortical neurons
      var pyramidalNeurons=[];//modelling pyramidal neurons
     // var redStuff=[];//the interference
      var nPyramidalBranches=1024;//preset per pNeuron enabling min 2 spines for cNeuron re-activation from branches from pyramidal (i.e. top down)
      var ratioCortical2Pyramidal=5;//was 5 for max pyramidalNeurons preset for ratio of corticalNeurons to pyramidalNeurons 3 is quite slow to initialize.
      var mustPercieveSeries=3;//progressive perception
      var mustPercieve=0;// 
      
      var branchesReq4Perception=3;//;3//preset for number of branches required to re-activate resting cNeuron
           //used in tryPerception to promote a resting neuron to active state
           //ONLY 3 Seems to work but we get some cross talk
     
      var SpinesAdded=0;
      var corticalNeuronsActivated=0;
      var delayForFields=250;//was 2000 
      var delayMin=250;

      var cOffX=350;//300+padding
      var cOffY=50;//padding of the body tag
      var offsetx=cOffX;//preset for demo which is 350 px to the right      
 
      function doBodyLoad(){
        document.getElementById("imgSelector").addEventListener("click",function(event){  
                    var cX=event.clientX;
                    var cY=event.clientY;
                    var pick=parseInt((cX-600)/65);                 
                    switch(pick){
                      case 5:
                      loadImage2Sense("color.jpg");
                        break;                     
                        case 0:
                      loadImage2Sense("BillBrandt1.png");
                        break;
                        case 1:
                      loadImage2Sense("BillBrandt3.png");
                        break;
                        case 2:
                      loadImage2Sense("BillBrandt4.png");
                        break;
                        case 3:
                      loadImage2Sense("a_and_z.png");
                        break;
                        case 4:
                      loadImage2Sense("blink.png");
                        break;
                        case 6:
                      loadImage2Sense("car.png");
                      break;
                        case 7:
                      loadImage2Sense("movedx.png");
                        break;
                      default:
                      loadImage2Sense("blink.png");
                        break;

                    }
                    document.getElementById("imgSelector").style.display="none";
                    document.getElementById("key2").innerHTML="key2"; 
                    document.getElementById("key3").innerHTML="Key3";
                },false);
        loadFirstImage();
        
      }

      function button1(){
        nowSay("button1");        
        var buttonText=document.getElementById("key1").innerHTML;
        if(buttonText=="Future"){//future use
        }       
      }
      function button2(){
        nowSay("button2");
        var buttonText=document.getElementById("key2").innerHTML;
        if(buttonText=="Begin Random Partial Perception"){          
          nowSay("Activating Random Partial Perception from a piece of the original image - few seconds");
          setUpPartialRandomPerceptionTest();
        }
      }
      function button3(){
        nowSay("button3");
        var buttonText=document.getElementById("key3").innerHTML;
        if(buttonText=="Load Other Image"){
          
          nowSay("Activating new Cortical Neuron Pattern");
          showNewImageInterface();
        }
      }

      
      function loadImage2Sense(fName){//called by showNewImageInterface
        var img1 = new Image();
        sensoryCanvas= document.getElementById('imageToSense');
        img1.onload = function () {
          sensoryCtx = sensoryCanvas.getContext('2d');
          sensoryCtx.drawImage(img1, 0, 0); 
          nowSay("loaded"); 
          imgData = sensoryCtx.getImageData(0, 0, gridWidth, gridHeight);
          var data = imgData.data;
          theDataLength=data.length;
          setTimeout(convertToBlackWhite,delayMin);//always 
        };
        img1.src = fName;
      }

      function convertToBlackWhite(){
          var pix1,pix2,pix3;
          var total=0;
          for(var i=0;i<theDataLength;i+=4){
            pix1=0.2126 * imgData.data[i];pix2=0.7152 *imgData.data[i+1];pix3= 0.0722 *imgData.data[i+2];//forget alpha
            total=(pix1+pix2+pix3);
            if(total<70){
              imgData.data[i]=0;imgData.data[i+1]=0;imgData.data[i+2]=0;
            }
            else{
              imgData.data[i]=255;imgData.data[i+1]=255;imgData.data[i+2]=255;
            }
          }
          sensoryCtx.putImageData(imgData, 0, 0);
          setTimeout(cortexPrepNewImage,delayMin);//always 
      }

      function convertyellowtored(){
          var pix1,pix2,pix3;
          var total=0;
          for(var i=0;i<theDataLength;i+=4){
            if( imgData.data[i]==255&&imgData.data[i+1]==255){imgData.data[i+1]=0;}           
          }
          corticalCtx.putImageData(imgData, 0, 0);          
      }


      function loadFirstImage() {//only once
        sensoryCanvas= document.getElementById('imageToSense');
          if (sensoryCanvas.getContext) {
            sensoryCtx = sensoryCanvas.getContext('2d');
              var img1 = new Image();
              img1.onload = function () {
                sensoryCtx.drawImage(img1, 0, 0); 
                nowSay("loaded"); 
                gridWidth=300;
                gridHeight=300;
                imgData = sensoryCtx.getImageData(0, 0, gridWidth, gridHeight);
                var data = imgData.data;
                theDataLength=data.length;
                initializeBrain(img1);  
              };
              img1.src = 'a_and_z.png';
          }
      }

      function getRandomInt(max) {
         return Math.floor(Math.random() * max);
      }

      function isBranchAmongBranches(cP,cN){
        var ml=pyramidalNeurons[cP].branches.length;
        for (var cc=0;cc<ml;cc++){
           if(pyramidalNeurons[cP].branches[cc].CNID==cN){//Duplicate
              return 1;
            }
        }
        return 0;
      }

      function showAllActivePyramidalBranchEnds(){        
        var pyrs=pyramidalNeurons.length;
        for (var i=0;i<pyrs; i++){
          showAxonBranchesOf(i,1,0);//just the tips
        }
        document.getElementById("key1").innerHTML="Ready";
        if(mustPercieve>1){
          perceive();
        }
        else{
          nowSay("The activated neurons are shown in yellow, where "+branchesReq4Perception+" or more spines were reactivated");
          showActiveCorticalNeurons();
          document.getElementById("key2").innerHTML="Begin Random Partial Perception"; 
          document.getElementById("key3").innerHTML="Load Other Image";
          
        }
      }
      
      function setUpPartialRandomPerceptionTest(){
        document.getElementById("key2").innerHTML="key2"; 
        document.getElementById("key3").innerHTML="Key3";          
        //choose zone
        var offsetStartx=getRandomInt(149);
        var offsetStarty=getRandomInt(149);
        //copy the zone
        imgData = sensoryCtx.getImageData(0, 0, gridWidth, gridHeight); 
        corticalCtx.fillStyle="white";
        corticalCtx.fillRect(0, 0, gridWidth, gridHeight);
        corticalCtx.putImageData(imgData, 0, 0, offsetStartx, offsetStarty, 
          gridWidth/2, gridHeight/2);
          //clear the active states for neurons and spines and pneuron branches
        setUpCortexActivation();         
          nowSay("clearing perception field");
          mustPercieve=mustPercieveSeries;
        perceive();
      }

      function perceive(){
        if (mustPercieve>0){
          mustPercieve-=1;
          setTimeout(backPropagate,delayMin);
        }
      }

      function showNewImageInterface(){
        document.getElementById("key2").innerHTML="key2"; 
        document.getElementById("key3").innerHTML="Key3";
        document.getElementById("imgSelector").style.display="block";
      }
      
      function cortexPrepNewImage(){
        //console.log("setting up new image");
        for (var a=0;a<corticalNeurons.length;a++){
          deactivateSpines(a);
          corticalNeurons[a].active=0;
        }
        for (var a=0;a<pyramidalNeurons.length;a++){
          pyramidalNeurons[a].active=0;
        }
        simulateThalamicProjection("New Image Activating");       
        for (var a=0;a<pyramidalNeurons.length;a++){
          for (var j=0;j<nPyramidalBranches;j++){
            if(pyramidalNeurons[a].branches[j].activeSpine>0){
              pyramidalNeurons[a].branches[j].activeSpine=0;
            }
          }
        }
        setTimeout(hump,delayMin);       
      } 

      function hump(){
        setUpCortexActivation();  
        setTimeout(backPropagate,delayMin);
      }

      function confirmActiveNeurons(){      
        imgData = corticalCtx.getImageData(0, 0, gridWidth, gridHeight);
        var indeX=0;
        for (var i = 0; i <corticalNeurons.length; i++) { 
           if(corticalNeurons[i].active ){  
            indeX=(corticalNeurons[i].x%gridWidth)*4+corticalNeurons[i].y*gridWidth*4;            
            imgData.data[indeX]=255;
            imgData.data[indeX+1]=255;                    
          }
        } 
        corticalCtx.putImageData(imgData, 0, 0);
        showActiveCorticalNeurons();//more emphasized for easier pyr excitations
        
      }

      function showActiveCorticalNeurons(){
        corticalCtx.lineWidth = 2;
        corticalCtx.strokeStyle = 'rgba(255,255,0,1)';
        for (var i = 0; i <corticalNeurons.length; i++) {
           if(corticalNeurons[i].active ){   
            corticalCtx.beginPath();
            corticalCtx.arc(corticalNeurons[i].x, corticalNeurons[i].y, 1, 0,0.25* Math.PI);
            corticalCtx.stroke();           
          }
        }
      }

      function showAxonBranchesOf(id,linked,altcol){
        var targx,targy;
        corticalCtx.lineWidth = 1;
        if (linked){//just tips
          for (var j=0;j<nPyramidalBranches;j++){
            if(pyramidalNeurons[id].branches[j].activeSpine>0){//just show the activated branch
              if(pyramidalNeurons[id].branches[j].cNeuronId!=-1){
                if(corticalNeurons[[pyramidalNeurons[id].branches[j].cNeuronId]].active&&
                  pyramidalNeurons[id].active ){
                  corticalCtx.beginPath();
                  corticalCtx.strokeStyle = 'rgba(0,0,255,1)';
                  corticalCtx.moveTo(pyramidalNeurons[id].branches[j].x,pyramidalNeurons[id].branches[j].y);
                  targx=pyramidalNeurons[id].branches[j].x+(pyramidalNeurons[id].branches[j].x-pyramidalNeurons[id].x)/35;
                  targy=pyramidalNeurons[id].branches[j].y+(pyramidalNeurons[id].branches[j].y-pyramidalNeurons[id].y)/35;
                  corticalCtx.lineTo(targx,targy);
                  corticalCtx.stroke();
                  corticalCtx.closePath();
                  corticalCtx.beginPath();
                  corticalCtx.strokeStyle = 'rgba(100,0,100,0.25)';
                  corticalCtx.moveTo(pyramidalNeurons[id].x,pyramidalNeurons[id].y);
                  targx=pyramidalNeurons[id].x+(pyramidalNeurons[id].branches[j].x-pyramidalNeurons[id].x)/30;
                  targy=pyramidalNeurons[id].y+(pyramidalNeurons[id].branches[j].y-pyramidalNeurons[id].y)/30;
                  corticalCtx.lineTo(targx,targy);            
                  corticalCtx.stroke();
                  corticalCtx.closePath();
                }
              }
            }
          }
        }
        else{//full branches
          for (var j=0;j<nPyramidalBranches;j++){
            if(pyramidalNeurons[id].branches[j].cNeuronId!=-1){
              if(corticalNeurons[ [pyramidalNeurons[id].branches[j].cNeuronId] ].active &&
                  pyramidalNeurons[id].active ){
                corticalCtx.beginPath();
                if(!altcol){corticalCtx.strokeStyle = 'rgba(0,150,255,0.25)';}
                else{corticalCtx.strokeStyle = 'rgba(50,255,200,0.25)';}
                corticalCtx.moveTo(pyramidalNeurons[id].branches[j].x,pyramidalNeurons[id].branches[j].y);
                targx=pyramidalNeurons[id].x;
                targy=pyramidalNeurons[id].y;
                corticalCtx.lineTo(targx,targy);
                corticalCtx.stroke();
                corticalCtx.closePath();
              }
            }
          }
        }        
      }
      
      function activatePyramidalsUponBackPropagation(){
        var redStuff=[];//the activation fields
        var neighbors=0;
        var overlapArray=[];//modeling locations of overlap
        pixelData = corticalCtx.getImageData(0,0, gridWidth, gridHeight).data;
        var count=0;  
        for(var id=0;id<pyramidalNeurons.length;id++){
          pyramidalNeurons[id].active=0;
        }
        for (var y=0;y<gridHeight;y++){
          for(var x=0;x<gridWidth;x++){
            redStuff.push(pixelData[count]); 
            count+=4;
          }
        }
        for (var y=1;y<gridHeight-2;y+=2){//work of a retina actually
          for (var x=1;x<gridWidth-2;x+=2){
            neighbors=0;  
            count=y*gridWidth+x;          
            if(redStuff[count]==255){neighbors++;}//center
            if(redStuff[count-1]==255){neighbors++;}//left
            if(redStuff[count-gridWidth]==255){neighbors++;}//above
            if(redStuff[count+gridWidth]==255){neighbors++;}//below
            if(redStuff[count+1]==255){neighbors++;}//right
            if(redStuff[count-gridWidth-1]==255){neighbors++;}//leftabove
            if(redStuff[count-gridWidth+1]==255){neighbors++;}//right above
            if(redStuff[count+gridWidth+1]==255){neighbors++;}//right below            
            if(redStuff[count+gridWidth-1]==255){neighbors++;}//left below
            if(//neighbors==1||
              neighbors==2||neighbors==3){//TRIGGER THE PYRAMIDAL    
              overlapArray.push({x,y});            
            }
          }
        }        
        for(var c=0;c<overlapArray.length;c++){
          var x=overlapArray[c].x;
          var y=overlapArray[c].y;
          for (var i=0;i<pyramidalNeurons.length; i++){
            /*if(pyramidalNeurons[i].x==x&&pyramidalNeurons[i].y==y){
            */
            if((pyramidalNeurons[i].x==x||pyramidalNeurons[i].x==x+1)&&
              (pyramidalNeurons[i].y==y||pyramidalNeurons[i].y==y+1)){                
              pyramidalNeurons[i].active=1;
              activateAxonBranchesOf(i);
            }
          }
        }           
      }

      function getpyramidalNeuronAt(x,y){
        var foundPNs=[];
        if(pyramidalNeurons.length<1){
          return "no p neurons";
        }
        var matching=0;
        for (var i=0;i<pyramidalNeurons.length; i++){
          if(pyramidalNeurons[i].x<x+6&&pyramidalNeurons[i].x>x-6&&pyramidalNeurons[i].y<y+6&&pyramidalNeurons[i].y>y-6){
            showAxonBranchesOf(i,0,0);
            matching++;
            foundPNs.push(i);
          }
        }        
        if(matching>0){
          var rstr="found "+matching+" pyramidal: ";
          for (var a=0;a<foundPNs.length;a++){
            rstr+=foundPNs[a]+", ";
          }
          return(rstr +" found");
        }
        return("no match out of "+pyramidalNeurons.length );
      }

      function deactivateSpines(neuron){
        var spineCount=corticalNeurons[neuron].spines.length;
        corticalNeurons[neuron].branchcount=0;
        corticalNeurons[neuron].active=0;
        if (spineCount>0){
          for (var i = 0; i <spineCount; i ++) {
            corticalNeurons[neuron].spines[i].state=0;  
          }
        }
        spineCount=corticalNeurons[neuron].synapses.length;
        if (spineCount>0){
          for (var i = 0; i <spineCount; i ++) {
            corticalNeurons[neuron].synapses.pop();                
          }
        }
      }
      
      function activateAxonBranchesOf(pyram){
        for(var bs=0; bs<pyramidalNeurons[pyram].branches.length;bs++){
          if(pyramidalNeurons[pyram].branches[bs].cNeuronId!=-1){
            if(corticalNeurons[pyramidalNeurons[pyram].branches[bs].cNeuronId].active ){
              //neuron already active therefore we can add spines from an active pyramidal
              createNewMemorySpine(pyram,pyramidalNeurons[pyram].branches[bs].cNeuronId);
            }         
            else{//target Cortical neuron is resting           
              if(corticalNeurons[pyramidalNeurons[pyram].branches[bs].cNeuronId].spines.length>0){//target Cortical neuron has spines              
                for(var as=0;as<corticalNeurons[pyramidalNeurons[pyram].branches[bs].cNeuronId].spines.length;as++){                           
                  if( corticalNeurons[pyramidalNeurons[pyram].branches[bs].cNeuronId].spines[as].id==pyram){
                    tryPerception(pyram, pyramidalNeurons[pyram].branches[bs].cNeuronId);
                    pyramidalNeurons[pyram].branches[bs].activeSpine=1;
                  }
                }            
              }
            }        
          }
        }
      }

      function createNewMemorySpine(pyram,neuronID){ 
        //activate + or add  pyramidal branch spine to active neuron
        var spineCount=corticalNeurons[neuronID].spines.length;
        var spineFound=0;
        if (spineCount==0){
          corticalNeurons[neuronID].spines.push({
            id:pyram,//.index,
            state:1
          });//add the pyramidal to the list of spines and set active
          corticalNeurons[neuronID].branchcount++;
        }else{
          for (var i = 0; i <spineCount; i++) {
            if(corticalNeurons[neuronID].spines[i].id==pyram){
              spineFound=1;
              corticalNeurons[neuronID].spines[i].state=1;
              break;
            }
          }
          if(!spineFound){
            corticalNeurons[neuronID].spines.push({
              id:pyram,//.index,
              state:1
            });
            //THIS IS NEW MEMORY FORMATION by Synchronous Activation               
            corticalNeurons[neuronID].branchcount++;
          }
        }
      }

      function tryPerception(pyram,neuronID){ //this can be  perception if active spine count is over the perception threshold
        //activate pyramidal branch spine on a resting neuron
        var synapseFound=0;
        var cursubActive=0;//corticalNeurons[neuronID].branchcount;
        var synapseCount=corticalNeurons[neuronID].synapses.length;
        if (synapseCount<1){
          corticalNeurons[neuronID].synapses.push({
            id:pyram,//.index,
            state:1
          });
        }
        else{
          for (var i = 0; i <synapseCount; i ++) {//update that synapse
            if(corticalNeurons[neuronID].synapses[i].id==pyram){
              synapseFound++;
              corticalNeurons[neuronID].synapses[i].state=1;
              break;
            }
          }
          if(!synapseFound){corticalNeurons[neuronID].synapses.push({
              id:pyram,//.index,
              state:1
            });
          }
          synapseCount=corticalNeurons[neuronID].synapses.length;
          
          if(synapseCount+cursubActive>=branchesReq4Perception){
            //go active
            corticalNeurons[neuronID].branchcount=branchesReq4Perception;
            corticalNeurons[neuronID].active=1; 
            //this is perceptive reflex          
            for(k=0;k<synapseCount;k++){
              corticalNeurons[neuronID].synapses.pop();
            }             
          }
        }
      }
      
      function backPropagate(){       
        nowSay("Making Pyramidal branch spines with synchronously active Cortical Neurons");       
        convertyellowtored();
        activatePyramidalsUponBackPropagation();
        if(!mustPercieve){ //progressive perception
          setTimeout(showAllActivePyramidalBranchEnds,delayForFields); 
        }else{
          setTimeout(showAllActivePyramidalBranchEnds,delayMin); 
        }
      }   

      function simulateThalamicProjection(stuff){//activate cortical neurons graphically
        //this function will be replaced by Thalamic Object Behavior in future development
        imgData = sensoryCtx.createImageData(gridWidth, gridHeight);
        var idex=0;
        for (var i = 0; i <theDataLength; i += 4) {
          var activeN=corticalNeurons[idex++].active;
          if(activeN>0){activeN=255;}
          imgData.data[i]=activeN;
          imgData.data[i+1]=activeN;//yellow is on red and green
          imgData.data[i+2]=0;
          imgData.data[i+3]=255;//overlay
        }       
        corticalCtx.drawImage(sensoryCanvas,0,0,gridWidth,gridHeight,0,0,gridWidth,gridHeight);
        nowSay(stuff + " - Cortical neurons showing marks in yellow len="+theDataLength);
      }

      function setUpCortexActivation(){
        corticalNeuronsActivated=0;
        imgData = corticalCtx.getImageData(0, 0, gridWidth, gridHeight);
        theDataLength=imgData.data.length;
        var pNcount=0;
        var cNcount=0;
        for (var i = 0; i < theDataLength; i += 4) {         
          //activate cNeuron array to with the image AND  set neurons active in display data array at same time
          var xpos=parseInt (i/4%gridWidth);
          var ypos=parseInt (i/4/gridWidth);
          var black=0;/// the source image is black marks on white background.         
          if(imgData.data[i]==0){
            black=1;
            imgData.data[i] =255;
            imgData.data[i+1] =255;
            imgData.data[i + 2] = 0;
            corticalNeuronsActivated++;
          }
          else{
            black=0;
            imgData.data[i] =0;
            imgData.data[i+1] =0;
            imgData.data[i + 2] = 0;
          }
          corticalNeurons[cNcount].active=black;                   
          cNcount++;
        }
        corticalCtx.putImageData(imgData, 0, 0);
        deactivatePyramidalSpines();
      }

      function  deactivatePyramidalSpines(){
        for (var a=0;a<pyramidalNeurons.length;a++){
          for (var j=0;j<nPyramidalBranches;j++){
            if(pyramidalNeurons[a].branches[j].activeSpine>0){
              pyramidalNeurons[a].branches[j].activeSpine=0;
            }
          }
        }
      }

      function createAxonBranches(){      
        var pyrs=pyramidalNeurons.length;
        var cneurs=corticalNeurons.length;
        for (var i=0;i<pyrs;i++){
          for (var j=0;j<nPyramidalBranches;j++){   
            var  CNID=getRandomInt(cneurs);          
            pyramidalNeurons[i].branches.push({
                cNeuronId:CNID,
                activeSpine:0,
                x:corticalNeurons[CNID].x,
                y:corticalNeurons[CNID].y    
              });
          }
          for (var j=0;j<nPyramidalBranches;j++){
            var  CNID=pyramidalNeurons[i].branches[j].cNeuronId;
            if(isBranchAmongBranches(i,CNID)) {
              pyramidalNeurons[i].branches[j].cNeuronId=-1;
            } 
          }
        } 
      }

      function initializeBrain(image) {//only once        
        corticalCanvas = document.getElementById("corticalCanvas"); 
        sensoryCanvas.width=image.naturalWidth;
        corticalCanvas.width = image.naturalWidth;
        sensoryCanvas.height=image.naturalHeight;
        corticalCanvas.height = image.naturalHeight;
        corticalCtx = corticalCanvas.getContext("2d");
        corticalCtx.drawImage(image, 0, 0);
        sensoryCtx.drawImage(image, 0, 0); 
        gridWidth=corticalCanvas.width;
        gridHeight=corticalCanvas.height;// keep comment for manual 
        //nowSay("Click on Begin above");  
        initializeBrainScreen();  
       document.getElementById("key1").innerHTML="Initializing Neurons Please Wait";
          nowSay("Creating a million neurons and thirty million axon branches");            
        setTimeout(InitialActivationofCorticalNeurons,200);  
      }//end initialize function

      function initializeBrainScreen(){  //once
        corticalNeuronsActivated=0;
        imgData = corticalCtx.getImageData(0, 0, gridWidth, gridHeight);
        var data = imgData.data;
        theDataLength=data.length;
        var pNcount=0;
        document.getElementById("nPyramidalBranches").innerHTML=nPyramidalBranches+"";
        document.getElementById("branchesReq4Perception").innerHTML=branchesReq4Perception+""; 
        document.getElementById("branchesReq4Perception2").innerHTML=branchesReq4Perception+"";  
        var idex=0;       
        for (var i = 0; i < theDataLength; i += 4) {         
          //Create the cNeuron array to accommodate the image AND  set neurons active in display data array at same time
          var xpos=parseInt (i/4%gridWidth);
          var ypos=parseInt (i/4/gridHeight);
          var black=0;/// the source image is black marks on white background.
          var gColor =(data[i] +  data[i + 1] +  data[i + 2])/3;// make a grey from the 3 guns
          data[i] = gColor;
          data[i + 1] = 0;
          data[i + 2] = gColor;//red and blue make purple
          if(data[i]==0){
            black=1;
            corticalNeuronsActivated++;
          }
          corticalNeurons.push({
              index:idex++,
              active:black,//using the redchannel
              branchcount:0,
              x:xpos,
              y:ypos,
              spines: [] ,
              synapses: []   
          });
          if(!(ypos%ratioCortical2Pyramidal)){ 
            if(!(xpos%ratioCortical2Pyramidal)){     
              pyramidalNeurons.push({
                index:pNcount++,
                active:0,
                x:xpos,
                y:ypos,
                branches: []      
              });
            } 
          }      
        }
      }

      function InitialActivationofCorticalNeurons(){
        //only done once in this script
        simulateThalamicProjection("activating");//keep comments
        createAxonBranches();//now that all corticalNeurons and pyramidalNeurons are built, let the pNeuron branches find targets.
        corticalCtx.putImageData(imgData, 0, 0, 0, 0, gridWidth, gridHeight);
                corticalCanvas.addEventListener("click",function(event){  
                    var cX=event.clientX;
                    var cY=event.clientY;
                    var pixelData = corticalCtx.getImageData(cX, cY, 1, 1).data; 
                    var mX=   cX-cOffX;
                    var mY=   cY-cOffY;
                    nowSay('point x='+(mX)+' point y='+(mY)+ " pyram neuron(s) "+ getpyramidalNeuronAt(mX,mY));                   
                },false);
                corticalCanvas.addEventListener("contextmenu",function(event){ 
                    var cX=event.clientX;
                    var cY=event.clientY;
                    var pixelData = corticalCtx.getImageData(cX, cY, 1, 1).data; 
                    var mX=   cX-cOffX;
                    var mY=   cY-cOffY;
                    nowSay('point x='+(mX)+' point y='+(mY)+ " cortical neuron "+ getCorticalNeuronAt(mX,mY));  
                    event.preventDefault(); 
                    return true;                
                },false);
        backPropagate();
      }
 
      function getCorticalNeuronAt(x,y){
        var gridpoint=x+y*gridWidth;
        var activespines=0;
        if(corticalNeurons.length<1){
          return "no neurons";
        }
        if(gridpoint>-1&&gridpoint<corticalNeurons.length){
          for(m=-4;m<4;m++){
            for(n=-4;n<4;n++){
              if(m+x>=0&&m+x<gridWidth && n+y>=0&&n+y<gridHeight){
                gridpoint=m+x+(y+n)*gridWidth;
                if(gridpoint<corticalNeurons.length){
                  if(corticalNeurons[gridpoint].active){
                    for (var f=0; f<corticalNeurons[gridpoint].spines.length;f++){
                      var pyramidalNeuronId=corticalNeurons[gridpoint].spines[f].id;
                      if(corticalNeurons[gridpoint].spines[f].state){
                        showAxonBranchesOf(pyramidalNeuronId,0,1);
                        activespines++;
                      }
                    }
                    return (", pt="+corticalNeurons[gridpoint].x+","+corticalNeurons[gridpoint].y+" active="+corticalNeurons[gridpoint].active+
                      ", id="+ gridpoint+" active spines ="
                      +activespines+" tot spines ="+ corticalNeurons[gridpoint].spines.length);
                  }
                }
              }
            }
          }
        }
        else{
              return (corticalNeurons[gridpoint].x+","+corticalNeurons[gridpoint].y+" active="+corticalNeurons[gridpoint].active+
              ", id="+"   tot neurons= "+corticalNeurons.length);
          
        }
        return("no match out of "+corticalNeurons.length + "   gridpoint="+ gridpoint);
      }
      function nowSay(stuff) {
        document.getElementById("mess").textContent=stuff;
      }
   
 
    </script>
     
  </body>
</html>
